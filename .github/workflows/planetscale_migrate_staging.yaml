name: db-migrate-staging
run-name: PlanetScale Migrate staging branch by @${{ github.actor }}
on:
  pull_request:
#    branches: [ main ]
#    paths: [ "db/migrations/**" ]

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/setup_environment
      - name: Install Test Dependencies
        run: |
          go install github.com/pressly/goose/cmd/goose@latest
      - name: Install PlanetScale CLI
        run: |
          curl -L https://github.com/planetscale/cli/releases/latest/download/pscale_linux_amd64.deb -o pscale.deb
          sudo dpkg -i pscale.deb
      - name: Authenticate with PlanetScale
        run: pscale auth login --service-token-id ${{ secrets.PLANETSCALE_SERVICE_TOKEN_ID }} --service-token ${{ secrets.PLANETSCALE_SERVICE_TOKEN }}
      - name: Run Migration
        env:
          DB_USER: ${{ secrets.PLANETSCALE_STAGING_DB_USER }}
          DB_PASSWORD: ${{ secrets.PLANETSCALE_STAGING_DB_PASSWORD }}
          DB_NAME: poroto
          DB_HOST: localhost
          DB_POST: 3309
          PLANETSCALE_DB_NAME: poroto
          PLANETSCALE_ORG_NAME: poroto
          PLANETSCALE_DB_BRANCH: staging
        run: |
          pscale connect $PLANETSCALE_DB_NAME $PLANETSCALE_DB_BRANCH --org $PLANETSCALE_ORG_NAME --port $DB_PORT --execute "goose -dir db/migrations mysql \"$DB_USER:$DB_PASSWORD@tcp($DB_HOST:$DB_PORT)/$DB_NAME?parseTime=true&loc=Asia%2FTokyo&tls=true\" up"